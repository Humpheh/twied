<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1. Guide &mdash; twied 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="twied 0.2 documentation" href="index.html" />
    <link rel="next" title="2. twied.twicol — Twitter Collection" href="collection.html" />
    <link rel="prev" title="Welcome to twied‘s documentation!" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="collection.html" title="2. twied.twicol — Twitter Collection"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to twied‘s documentation!"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">twied 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="guide">
<h1>1. Guide<a class="headerlink" href="#guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="installation">
<h2>1.1. Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Below is a guide on how to setup and use the package. This package required <em>Python 3</em>. A number of other
modules are required for the module to function correctly. Installing the module using <em>pip</em> should automatically
include all of these modules, however they may need to be retrieved seperately.</p>
<p>Required modules and supported versions can be seen here: <a class="reference external" href="https://github.com/Humpheh/twied/blob/master/requirements.txt">https://github.com/Humpheh/twied/blob/master/requirements.txt</a>.</p>
<p><strong>Pip Installation:</strong></p>
<p><cite>twied</cite> can be installed via pip:</p>
<div class="highlight-bash"><div class="highlight"><pre>pip install git+https://github.com/Humpheh/twied.git
</pre></div>
</div>
<p><strong>Source Code:</strong></p>
<p>The source code for <cite>twied</cite> can be retrieved from <em>GitHub</em> <a class="reference external" href="https://github.com/Humpheh/twied">https://github.com/Humpheh/twied</a>. This can
be cloned using:</p>
<div class="highlight-bash"><div class="highlight"><pre>git clone https://github.com/Humpheh/twied.git
</pre></div>
</div>
<p><strong>Example Scripts:</strong></p>
<p>Example usage scripts can be seen in the <em>GitHub</em> repository under the directory <cite>/scripts/examples</cite>.</p>
</div>
<div class="section" id="example-system">
<h2>1.2. Example System<a class="headerlink" href="#example-system" title="Permalink to this headline">¶</a></h2>
<p>Below is an image which shows the layout of components within a system. This system was originally
designed for use in the authors dissertation.</p>
<img alt="_images/projectsystem.png" src="_images/projectsystem.png" />
</div>
<div class="section" id="slp-example">
<h2>1.3. SLP Example<a class="headerlink" href="#slp-example" title="Permalink to this headline">¶</a></h2>
<p>Below is an example of the slp method.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This implementation is not complete and will not work outright
without further work.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Testing the spatial label propagation algorithm.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">NoOptionError</span>

<span class="kn">import</span> <span class="nn">twieds</span>
<span class="kn">from</span> <span class="nn">labelprop.inference</span> <span class="kn">import</span> <span class="n">InferSL</span>

<span class="c"># Must run this as a script</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">twieds</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="s">&quot;logs/labelprop.log&quot;</span><span class="p">,</span> <span class="s">&quot;settings/locinf.ini&quot;</span><span class="p">)</span>

    <span class="c"># Connect to the MongoDB</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Connecting to MongoDB...&quot;</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;mongo&quot;</span><span class="p">,</span> <span class="s">&quot;address&quot;</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s">&quot;mongo&quot;</span><span class="p">,</span> <span class="s">&quot;port&quot;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Connected to MongoDB&quot;</span><span class="p">)</span>

    <span class="c"># Select the database and collection based off config</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;mongo&quot;</span><span class="p">,</span> <span class="s">&quot;database&quot;</span><span class="p">)]</span>
        <span class="n">user_col</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s">&quot;users&quot;</span><span class="p">]</span>
        <span class="n">user_col</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s">&#39;user.id&#39;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)],</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">user_col</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s">&#39;user.screen_name&#39;</span><span class="p">,</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">)])</span>
    <span class="k">except</span> <span class="n">NoOptionError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Cannot connect to MongoDB database and collection. Config incorrect?&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c"># Get the tweet collection</span>
    <span class="n">tweet_col</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;mongo&quot;</span><span class="p">,</span> <span class="s">&quot;collection&quot;</span><span class="p">)]</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tweet_col</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&#39;geo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;$ne&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span> <span class="s">&#39;locinf.sl.test&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
    <span class="n">infersl</span> <span class="o">=</span> <span class="n">InferSL</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">user_col</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">NEXT USER&quot;</span><span class="p">,</span> <span class="n">tweet</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">][</span><span class="s">&#39;screen_name&#39;</span><span class="p">],</span> <span class="s">&quot;:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">input</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;s&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">inf</span> <span class="o">=</span> <span class="n">infersl</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">tweet</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">test</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Inferred location:&quot;</span><span class="p">,</span> <span class="n">inf</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">)</span>

        <span class="c"># Store inferred loc in db</span>
        <span class="n">db</span><span class="o">.</span><span class="n">tweets</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="n">tweet</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]},</span> <span class="p">{</span>
            <span class="s">&#39;$set&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;locinf.sl.test&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">inf</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="n">inf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
</pre></div>
</div>
</div>
<div class="section" id="mi-example">
<h2>1.4. MI Example<a class="headerlink" href="#mi-example" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configuration">
<h3>1.4.1. Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>Below is a basic breakdown of how setting up for using the MI implementation would work:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Obtain the <cite>twied</cite> package.</li>
<li>Install prerequisite modules (<em>pip</em> likely will install them for you).</li>
<li>Download databases (see below for link).</li>
<li>Setup config file.</li>
<li>Create inference script.</li>
<li>Start inference.</li>
</ol>
</div></blockquote>
<p>Below is an example config file for use with the <a class="reference internal" href="locinf.html#twied.multiind.inference.InferThread" title="twied.multiind.inference.InferThread"><code class="xref py py-class docutils literal"><span class="pre">twied.multiind.inference.InferThread</span></code></a>
class. Each of the sections is broken down below the example.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[twitter]</span>
<span class="na">app_key</span> <span class="o">=</span> <span class="s">wYHFS6G9fqVNxYwt53UNUcxT0</span>
<span class="na">app_secret</span> <span class="o">=</span> <span class="s">MU3r4yi2HGDrAbBma2syPpOvFOcWFxaUIiKmeySX8Ard80lr53</span>
<span class="na">oauth_token</span> <span class="o">=</span> <span class="s">3950426785-SNgK3NmghSzdjLcJGRTAwQq3xyMait0bVQ6HVvV</span>
<span class="na">oauth_token_secret</span> <span class="o">=</span> <span class="s">x0FASasjEHqsSvLAZ3h6sqClPWtt54TcM78W8PLOJ1BLv</span>

<span class="k">[mongo]</span>
<span class="na">address</span> <span class="o">=</span> <span class="s">localhost</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">27017</span>
<span class="na">database</span> <span class="o">=</span> <span class="s">twitter</span>
<span class="na">collection</span> <span class="o">=</span> <span class="s">tweets</span>

<span class="c1">#### Settings for Multi-Indicator Approach ####</span>

<span class="k">[multiindicator]</span>
<span class="na">workers</span> <span class="o">=</span> <span class="s">10</span>
<span class="na">gadm_polydb_path</span> <span class="o">=</span> <span class="s">D:/ds/polydb_2.db</span>
<span class="na">tld_csv</span> <span class="o">=</span> <span class="s">D:/ds/tlds.csv</span>

<span class="k">[mi_weights]</span>
<span class="na">TAG</span> <span class="o">=</span> <span class="s">10</span>
<span class="na">COD</span> <span class="o">=</span> <span class="s">2.72</span>
<span class="na">GN</span> <span class="o">=</span> <span class="s">1.51</span>
<span class="na">GN_1</span> <span class="o">=</span> <span class="s">2.01</span>
<span class="na">GN_2</span> <span class="o">=</span> <span class="s">1.96</span>
<span class="na">GN_3</span> <span class="o">=</span> <span class="s">1.96</span>
<span class="na">SP</span> <span class="o">=</span> <span class="s">0.67</span>
<span class="na">LBS</span> <span class="o">=</span> <span class="s">4.26</span>
<span class="na">TZ</span> <span class="o">=</span> <span class="s">0.56</span>
<span class="na">WS_1</span> <span class="o">=</span> <span class="s">1.07</span>

<span class="k">[geonames]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">api.geonames.org</span>
<span class="na">user</span> <span class="o">=</span> <span class="s">humph</span>
<span class="na">limit</span> <span class="o">=</span> <span class="s">5</span>
<span class="na">fuzzy</span> <span class="o">=</span> <span class="s">0.8</span>

<span class="k">[dbpedia]</span>
<span class="na">spotlight_url</span> <span class="o">=</span> <span class="s">spotlight.sztaki.hu</span>
<span class="na">spotlight_port</span> <span class="o">=</span> <span class="s">2222</span>
<span class="na">spotlight_page</span> <span class="o">=</span> <span class="s">/rest/annotate</span>

<span class="k">[slinf]</span>
<span class="na">min_mentions</span> <span class="o">=</span> <span class="s">3</span>
<span class="c1"># 4</span>
<span class="na">max_depth</span> <span class="o">=</span> <span class="s">3</span>
<span class="na">req_locations</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">max_iterations</span> <span class="o">=</span> <span class="s">4</span>
<span class="na">num_timelines</span> <span class="o">=</span> <span class="s">2</span>
</pre></div>
</div>
<dl class="docutils">
<dt><strong>Fields:</strong></dt>
<dd><ul class="first last">
<li><p class="first"><strong>twitter</strong> - This section contains the settings for the Twitter API.
These settings are not directly used by the Inference class, so can be omitted.</p>
</li>
<li><p class="first"><strong>mongo</strong> - This section contains the connection information for the MongoDB,
including the location of the database, and the database and table names to infer the tweets from.</p>
</li>
<li><p class="first"><strong>multiindicator</strong> - The <em>workers</em> value is an integer value of the number of
simultaneous inference threads to run concurrently. The <em>gadm_polydb_path</em> is the location of the polygon
database (see below) and the <em>tld_csv</em> string is the location of the TLD to country name file (see below).</p>
</li>
<li><p class="first"><strong>mi_weights</strong> - This contains the weights of each of the indicators. The default
values in this config are the values lifted from the original paper.</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name"><cite>TAG</cite>:</th><td class="field-body">weight of geotag indicator</td>
</tr>
<tr class="field-even field"><th class="field-name"><cite>COD</cite>:</th><td class="field-body">weight of coordinate indicator</td>
</tr>
<tr class="field-odd field"><th class="field-name"><cite>GN</cite>:</th><td class="field-body">weight of default geonames indicator</td>
</tr>
<tr class="field-even field"><th class="field-name"><cite>GN_1</cite>:</th><td class="field-body">weight of geonames indicator when string split by &#8216;/&#8217;</td>
</tr>
<tr class="field-odd field"><th class="field-name"><cite>GN_2</cite>:</th><td class="field-body">weight of geonames indicator when string split by &#8216;-&#8216;</td>
</tr>
<tr class="field-even field"><th class="field-name"><cite>GN_3</cite>:</th><td class="field-body">weight of geonames indicator when backup message indicator is used</td>
</tr>
<tr class="field-odd field"><th class="field-name"><cite>SP</cite>:</th><td class="field-body">weight of message indicator</td>
</tr>
<tr class="field-even field"><th class="field-name"><cite>LBS</cite>:</th><td class="field-body">weight of location based services indicator (not implemented)</td>
</tr>
<tr class="field-odd field"><th class="field-name"><cite>TZ</cite>:</th><td class="field-body">weight of both timezone indicators</td>
</tr>
<tr class="field-even field"><th class="field-name"><cite>WS_1</cite>:</th><td class="field-body">weight of TLD indicator</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first"><strong>geonames</strong> - This contains settings for connecting to the geonames API. <em>limit</em> is the max
number of suggestions to return and <em>fuzzy</em> is the search fuzzy-ness parameter.</p>
</li>
<li><p class="first"><strong>dbpedia</strong> - This contains settings for the URL of the DBPedia spotlight interface.</p>
</li>
<li><p class="first"><strong>slinf</strong> - This can be omitted. Containted settings for the spatial label propagation method.</p>
</li>
</ul>
</dd>
<dt><strong>Files:</strong></dt>
<dd>The MI approach uses two main extra databases, the <em>polygon database</em> and the
<em>tld</em> database. These are compiled from various sources. Precompiled database
files can be downloaded here: <a class="reference external" href="https://drive.google.com/open?id=0B0xoZYJ_Tg1aYVhvNTRlRGRiLW8">https://drive.google.com/open?id=0B0xoZYJ_Tg1aYVhvNTRlRGRiLW8</a></dd>
</dl>
</div>
<div class="section" id="example-script">
<h3>1.4.2. Example Script<a class="headerlink" href="#example-script" title="Permalink to this headline">¶</a></h3>
<p>Below shows an example script for running the Multi-Indicator inference process. The file loads a configuration file,
connects to the MongoDB and then infers the tweets within that collection. Exceptions are also handled and delays are
created if there are problems. The script will also tweet to the authenticated Twitter account every 5000 tweets.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">twython</span> <span class="kn">import</span> <span class="n">Twython</span><span class="p">,</span> <span class="n">TwythonError</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span> <span class="nn">urllib3.exceptions</span> <span class="kn">import</span> <span class="n">MaxRetryError</span>

<span class="kn">from</span> <span class="nn">twied.multiind.inference</span> <span class="kn">import</span> <span class="n">InferThread</span>
<span class="kn">from</span> <span class="nn">twied.multiind.indicators.locfieldindicator</span> <span class="kn">import</span> <span class="n">GeonamesException</span>
<span class="kn">from</span> <span class="nn">twied.multiind.interfaces.webinterfaces</span> <span class="kn">import</span> <span class="n">GeonamesDecodeException</span>

<span class="c"># Setup configuration file</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;settings.ini&quot;</span><span class="p">)</span>

<span class="c"># Connect to the MongoDB (database twitter, collection tweets)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">)</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s">&quot;twitter&quot;</span><span class="p">][</span><span class="s">&quot;tweets&quot;</span><span class="p">]</span>

<span class="c"># Query used for selecting tweets, empty because target is all tweets</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c"># Setup a Twython object to tweet error message if problem</span>
<span class="n">api_settings</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="s">&#39;twitter&#39;</span><span class="p">]</span>
<span class="n">twitter</span> <span class="o">=</span> <span class="n">Twython</span><span class="p">(</span><span class="o">**</span><span class="n">api_settings</span><span class="p">)</span>


<span class="c"># Function for tweeting message if there is an error</span>
<span class="k">def</span> <span class="nf">tweetstr</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">twitter</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[!] Attemting to send tweet: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">string</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[+] Tweet sent.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>


<span class="c"># Name of inference task</span>
<span class="n">inf_name</span> <span class="o">=</span> <span class="s">&quot;MyCol&quot;</span>

<span class="c"># Name of the field to save the result to</span>
<span class="n">field</span> <span class="o">=</span> <span class="s">&quot;inf&quot;</span>

<span class="c"># Run the inference</span>
<span class="n">inf</span> <span class="o">=</span> <span class="n">InferThread</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">inf_id</span><span class="o">=</span><span class="n">inf_name</span><span class="p">,</span> <span class="n">tweetfunc</span><span class="o">=</span><span class="n">tweetstr</span><span class="p">,</span> <span class="n">tweetint</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">proc_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;[+] Starting inference...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inf</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[!] Inference finished successfully.&quot;</span><span class="p">)</span>
        <span class="n">tweetstr</span><span class="p">(</span><span class="s">&quot;@Humpheh </span><span class="si">%s</span><span class="s"> - finished successfully.&quot;</span> <span class="o">%</span> <span class="n">inf_name</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="k">except</span> <span class="n">MaxRetryError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[!] Got a MaxRetryError - sleeping for 2 mins...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c"># sleep for 5 mins</span>
    <span class="k">except</span> <span class="n">GeonamesException</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[!] Got a GeonamesException - sleeping for 10 mins...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c"># sleep for 10 mins</span>
    <span class="k">except</span> <span class="n">GeonamesDecodeException</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[!] Got a GeonamesDecodeException - sleeping for 2 mins...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c"># sleep for 2 mins</span>
    <span class="k">except</span> <span class="n">TwythonError</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[!] Exception caught&quot;</span><span class="p">)</span>
        <span class="n">tweetstr</span><span class="p">(</span><span class="s">&quot;@Humpheh </span><span class="si">%s</span><span class="s"> - exited due to a </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inf_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="k">raise</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="collection-example">
<h2>1.5. Collection Example<a class="headerlink" href="#collection-example" title="Permalink to this headline">¶</a></h2>
<p>Below is an example file using the collection class to collect tweets which
contain the word &#8216;Twitter&#8217;. This script saves these tweets in a MongoDB database
in the database &#8216;test&#8217; and the collection &#8216;coltest1&#8217;. A <code class="xref py py-class docutils literal"><span class="pre">CounterThread</span></code> is also
created which ouputs the number of tweets collected in the previous 5 seconds.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The API settings here have been altered so they are not valid. These would
need to be created for your own app from the <a class="reference external" href="https://apps.twitter.com/">Twitter API</a>.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">twied.twicol</span> <span class="kn">import</span> <span class="n">TweetStreamer</span><span class="p">,</span> <span class="n">CounterThread</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>

<span class="c"># Save the Twitter API settings</span>
<span class="n">api_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;app_key&#39;</span><span class="p">:</span> <span class="s">&#39;wYHFS6G9fqVNxYwt53UNUcxT0&#39;</span><span class="p">,</span>
    <span class="s">&#39;app_secret&#39;</span><span class="p">:</span> <span class="s">&#39;MU3r4yi2HGDrAbBma2syPpOvFOcWFxaUIiKmeySX8Ard80lr53&#39;</span><span class="p">,</span>
    <span class="s">&#39;oauth_token&#39;</span><span class="p">:</span> <span class="s">&#39;3950426785-SNgK3NmghSzdjLcJGRTAwQq3xyMait0bVQ6HVvV&#39;</span><span class="p">,</span>
    <span class="s">&#39;oauth_token_secret&#39;</span><span class="p">:</span> <span class="s">&#39;x0FASasjEHqsSvLAZ3h6sqClPWtt54TcM78W8PLOJ1BLv&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">search_str</span> <span class="o">=</span> <span class="s">&quot;twitter&quot;</span>

<span class="c"># Connect to the MongoDB and the correct collection</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">()</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s">&#39;test&#39;</span><span class="p">][</span><span class="s">&#39;coltest1&#39;</span><span class="p">]</span>

<span class="c"># Setup the counter thread to output status count ever 5 secs</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">CounterThread</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">count</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Recieved </span><span class="si">%i</span><span class="s"> tweets in last 5 seconds&quot;</span> <span class="o">%</span> <span class="n">count</span><span class="p">))</span>

<span class="c"># Setup the tweet streamer to listen to tweets with &#39;twitter&#39; in them</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">TweetStreamer</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">search_str</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">counter</span><span class="p">,</span> <span class="o">**</span><span class="n">api_settings</span><span class="p">)</span>

<span class="c"># Start the threads</span>
<span class="n">ts</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">counter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># Wait</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Exception caught...&quot;</span><span class="p">)</span>
    <span class="k">pass</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="c"># If excepted, close all threads</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Stopping collection.&quot;</span><span class="p">)</span>
    <span class="n">counter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="event-detection-example">
<h2>1.6. Event Detection Example<a class="headerlink" href="#event-detection-example" title="Permalink to this headline">¶</a></h2>
<p>The event detection is an object which you should setup and then feed tweets in ascending time
order via a method. Below is a basic example which shows connecting to the database, creating
an <a class="reference internal" href="eventdetection.html#twied.eventec.eventdetection.EventDetection" title="twied.eventec.eventdetection.EventDetection"><code class="xref py py-class docutils literal"><span class="pre">twied.eventec.eventdetection.EventDetection</span></code></a> object, and then feeding the tweets in. The
final step is getting the clusters from the object and saving them in a file. For more information about
how the EventDetection operates or the class parameters see the class documentation.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span> <span class="nn">twied.eventec.eventdetection</span> <span class="kn">import</span> <span class="n">EventDetection</span>

<span class="n">output_filename</span> <span class="o">=</span> <span class="s">&quot;output.pkl&quot;</span>

<span class="c"># Connect to the MongoDB</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">()</span>

<span class="c"># Select the database and collection</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s">&quot;twitter&quot;</span><span class="p">]</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s">&quot;ptweets&quot;</span><span class="p">]</span>

<span class="c"># Get the tweet cursor (sorted by timestamp - note slow if there is no index)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">no_cursor_timeout</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s">&#39;timestamp&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c"># Create the EventDetection object with the parameters</span>
<span class="n">tf</span> <span class="o">=</span> <span class="n">EventDetection</span><span class="p">(</span><span class="s">&#39;centre&#39;</span><span class="p">,</span> <span class="s">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">popmaploc</span><span class="o">=</span><span class="s">&#39;D:\ds\population\glds15ag.asc&#39;</span><span class="p">)</span>

<span class="c"># Process each tweet that has been found</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">process_tweet</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

<span class="c"># Get the clusters and save them</span>
<span class="n">allc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_all_clusters</span><span class="p">()</span>
<span class="n">carr</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">allc</span><span class="p">]</span>

<span class="c"># Dump the output to a pickle file to save it</span>
<span class="n">pkl_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">carr</span><span class="p">,</span> <span class="n">pkl_file</span><span class="p">)</span>
<span class="n">pkl_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1. Guide</a><ul>
<li><a class="reference internal" href="#installation">1.1. Installation</a></li>
<li><a class="reference internal" href="#example-system">1.2. Example System</a></li>
<li><a class="reference internal" href="#slp-example">1.3. SLP Example</a></li>
<li><a class="reference internal" href="#mi-example">1.4. MI Example</a><ul>
<li><a class="reference internal" href="#configuration">1.4.1. Configuration</a></li>
<li><a class="reference internal" href="#example-script">1.4.2. Example Script</a></li>
</ul>
</li>
<li><a class="reference internal" href="#collection-example">1.5. Collection Example</a></li>
<li><a class="reference internal" href="#event-detection-example">1.6. Event Detection Example</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to <cite>twied</cite>&#8216;s documentation!</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="collection.html"
                        title="next chapter">2. <code class="docutils literal"><span class="pre">twied.twicol</span></code> &#8212; Twitter Collection</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/guide.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="collection.html" title="2. twied.twicol — Twitter Collection"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to twied‘s documentation!"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">twied 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Humphrey Shotton.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>